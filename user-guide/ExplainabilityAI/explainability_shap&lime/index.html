<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Lamine TOURE" /><link rel="canonical" href="https://LamineTourelab.github.io/user-guide/ExplainabilityAI/explainability_shap%26lime/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Explainability shap&lime - LamineTourelab</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../style.css" rel="stylesheet" />
        <link href="../../../css/base.css" rel="stylesheet" />
        <link href="../../../css/bootstrap.min.css" rel="stylesheet" />
        <link href="../../../css/font-awesome.min.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Explainability shap\u0026lime";
        var mkdocs_page_input_path = "user-guide/ExplainabilityAI/explainability_shap\u0026lime.md";
        var mkdocs_page_url = "/user-guide/ExplainabilityAI/explainability_shap%26lime/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> LamineTourelab
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../USER_GUIDE_INDEX/">Getting Started</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guide</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../../USER_GUIDE_INDEX/">User Guide Index</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Bioinformatics</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Bioinformatics/SingleCellData/RNA_Velocity_analysis_scVelo/">Getting Started with RNA Velocity</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Bioinformatics/SingleCellData/SingleCellData_Preprocessing_with_scanpy/">Installation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Bioinformatics/SingleCellData/Trajectory_inference_With_CellRank/Trajectory_inference_With_CellRank/">Getting Started with CellRank</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Bioinformatics/SingleCellData/Readme/">Tutorials</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Machine learning</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Machine%20learning/Autoencoder/Autoencoder/">Autoencoder</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Machine%20learning/DecisionTrees_using_iris_dataset/DecisionTrees_using_iris_dataset/">DecisionTrees using iris dataset</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Machine%20learning/Transfer_learning_using_VGG16/Transfer_learning_using_VGG16/">Transfer learning using VGG16</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Machine%20learning/tensorflow_API_tutorial/tensorflow_API_tutorial/">tensorflow API tutorial</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">ExplainabilityAI</a>
    <ul class="current">
                <li class="toctree-l2 current"><a class="reference internal current" href="./">Explainability shap&lime</a>
    <ul class="current">
    <li class="toctree-l3"><a class="reference internal" href="#expression-data">Expression data</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#label-data">label data</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#class-imbalance-correct-using-imblearn">Class imbalance correct using imblearn</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">About</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../../about/release-notes/">Release Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../about/contributing/">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../../about/license/">License</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">LamineTourelab</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">User Guide</li>
          <li class="breadcrumb-item">ExplainabilityAI</li>
      <li class="breadcrumb-item active">Explainability shap&lime</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/LamineTourelab/LamineTourelab.github.io/user-guide/ExplainabilityAI/explainability_shap&lime.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <pre class="highlight"><code class="language-python">import pandas as pd
import numpy as np
import matplotlib.pyplot as plt</code></pre>
<h1 id="data-load-and-preprocessing">Data load and preprocessing<a class="headerlink" href="#data-load-and-preprocessing" title="Permanent link"></a></h1>
<h2 id="expression-data">Expression data<a class="headerlink" href="#expression-data" title="Permanent link"></a></h2>
<pre class="highlight"><code class="language-python">df = pd.read_table("~/Downloads/GLORY_20170922.genes_all_samples_TPM.txt", sep="\t", index_col=0)
df</code></pre>
<pre class="highlight"><code class="language-python">df.index = df['hugo_id']
df = df.drop(['hugo_id'], axis=1)
df = df.T
df.head()</code></pre>
<pre class="highlight"><code class="language-python">df.info()</code></pre>
<pre class="highlight"><code class="language-python">duplicate_columns = df.columns[df.columns.duplicated()]
duplicate_columns</code></pre>
<pre class="highlight"><code class="language-python">df = df.drop(columns=duplicate_columns)
df.head()</code></pre>
<h2 id="label-data">label data<a class="headerlink" href="#label-data" title="Permanent link"></a></h2>
<pre class="highlight"><code class="language-python">samples = pd.read_excel('~/Downloads/GBM_GLORY_sample_info.xlsx', index_col=0)
samples.head()</code></pre>
<pre class="highlight"><code class="language-python">Outcome = pd.DataFrame(samples['IDH1_STATUS-sequencing'])
Outcome.head()</code></pre>
<pre class="highlight"><code class="language-python">Outcome = Outcome.replace("MUT",1)
Outcome = Outcome.replace("WT",0)
Outcome.head()</code></pre>
<pre class="highlight"><code class="language-python">Outcome = Outcome[Outcome.index.isin(df.index)]
Outcome.head()</code></pre>
<pre class="highlight"><code class="language-python">print('Labels counts in Outcome:', np.bincount(Outcome['IDH1_STATUS-sequencing']))</code></pre>
<p>here we clearly dealing with class imbalance.</p>
<h3 id="class-imbalance-correct-using-imblearn">Class imbalance correct using imblearn<a class="headerlink" href="#class-imbalance-correct-using-imblearn" title="Permanent link"></a></h3>
<pre class="highlight"><code class="language-python">#!pip install -U imbalanced-learn</code></pre>
<pre class="highlight"><code class="language-python">from imblearn.over_sampling import RandomOverSampler
ros = RandomOverSampler(random_state=0)
df_resampled, Outcome_resampled = ros.fit_resample(df, Outcome['IDH1_STATUS-sequencing'])</code></pre>
<pre class="highlight"><code class="language-python">from collections import Counter
print(sorted(Counter(Outcome_resampled).items()))</code></pre>
<pre class="highlight"><code class="language-python">print('Labels counts in Outcome:', np.bincount(Outcome_resampled))</code></pre>
<h1 id="explainability">Explainability<a class="headerlink" href="#explainability" title="Permanent link"></a></h1>
<h2 id="lime">Lime<a class="headerlink" href="#lime" title="Permanent link"></a></h2>
<pre class="highlight"><code class="language-python">#!pip install lime
import lime </code></pre>
<pre class="highlight"><code class="language-python">X_train, X_test, y_train, y_test = train_test_split(df_resampled, Outcome_resampled, test_size=0.3, random_state=42)

model = xgb.XGBClassifier(objective ='binary:logistic', colsample_bytree = 0.3, learning_rate = 0.1,
                max_depth = 5, alpha = 10, n_estimators = 10)
model.fit(X_train, y_train)
pred= model.predict(X_test)</code></pre>
<pre class="highlight"><code class="language-python">y_pred = pd.DataFrame(model.predict(X_test), columns=['pred'], index=X_test.index)
y_pred.head()</code></pre>
<pre class="highlight"><code class="language-python">explainer = lime_tabular.LimeTabularExplainer(
    training_data=np.array(X_train),
    feature_names=X_train.columns,
    class_names= ['WT', 'MUT'],
    mode='classification'
)</code></pre>
<pre class="highlight"><code class="language-python">random.seed(10)
# Choose the instance and use it to predict the results. Here I use the 30th (below the 334 patient). 
exp = explainer.explain_instance(
    data_row=X_test.iloc[8], 
    #num_features: maximum number of features present in explanation. I keept default 10.
    #num_samples: size of the neighborhood to learn the linear model.Default 500.
    predict_fn=model.predict_proba
)
exp.show_in_notebook(show_table=True)</code></pre>
<pre class="highlight"><code class="language-python"># Show the results as list.
exp.as_list()</code></pre>
<pre class="highlight"><code class="language-python">%matplotlib inline
fig = exp.as_pyplot_figure()</code></pre>
<pre class="highlight"><code class="language-python">from lime import submodular_pick</code></pre>
<pre class="highlight"><code class="language-python"># Let's use SP-LIME to return explanations on a few sample data sets 
# and obtain a non-redundant global decision perspective of the black-box model
sp_exp = submodular_pick.SubmodularPick(explainer, 
                                        np.array(X_test),
                                        model.predict_proba,
                                        num_features=10,
                                        num_exps_desired=2)   </code></pre>
<pre class="highlight"><code class="language-python">[exp.as_pyplot_figure(label=exp.available_labels()[0]) for exp in sp_exp.sp_explanations]
print('SP-LIME Local Explanations')</code></pre>
<h2 id="shap">Shap<a class="headerlink" href="#shap" title="Permanent link"></a></h2>
<pre class="highlight"><code class="language-python">#!pip install shap
import shap</code></pre>
<pre class="highlight"><code class="language-python">explainer=shap.Explainer(model)
shap_values = explainer(X_train)
shap_contrib = explainer.shap_values(X_test)</code></pre>
<pre class="highlight"><code class="language-python">#import Javascript

#shap_values
shap.initjs(),
shap.plots.force(shap_values)</code></pre>
<pre class="highlight"><code class="language-python">#shap.plots.waterfall(shap_values[0])</code></pre>
<pre class="highlight"><code class="language-python"># Global bar plot
shap.plots.bar(shap_values, max_display=8)</code></pre>
<pre class="highlight"><code class="language-python"># Local bar plot for the patient 334 (index 8).
shap.plots.bar(shap_values[8], max_display=8)</code></pre>
<pre class="highlight"><code class="language-python">shap.plots.beeswarm(shap_values, max_display=8)</code></pre>
<h1 id="explainability-tools">Explainability Tools<a class="headerlink" href="#explainability-tools" title="Permanent link"></a></h1>
<h2 id="shapash">Shapash<a class="headerlink" href="#shapash" title="Permanent link"></a></h2>
<pre class="highlight"><code class="language-python">response_dict = {0: 'WT', 1:'MUT'}</code></pre>
<pre class="highlight"><code class="language-python">#!pip install shapash</code></pre>
<pre class="highlight"><code class="language-python">
#
from shapash import SmartExplainer
import tkinter as TK


xpl = SmartExplainer(
    model=model,
    #backend='shap' is the default.
    label_dict=response_dict  #Dictionary mapping integer labels to domain names (classification - target values).
    #preprocessing=encoder,   # Optional: compile step can use inverse_transform method
    #features_dict=name # optional parameter, specifies label for features name 
)

xpl.compile(
   contributions=shap_contrib, # Shap Contributions pd.DataFrame
    y_pred=y_pred,  #Prediction values (1 column only)
    x=X_test,  # a preprocessed dataset: Shapash can apply the model to it
    y_target=y_test #Target values (1 column only). 
)
</code></pre>
<pre class="highlight"><code class="language-python">xpl.plot.features_importance(max_features=10, label=1)
xpl.plot.scatter_plot_prediction()
#y_pred
xpl.filter(max_contrib=10)
xpl.plot.local_plot(index=334, label='MUT')
xpl.plot.compare_plot(row_num=[0, 1, 2, 3, 4, 5, 6], max_features=8)
</code></pre>
<pre class="highlight"><code class="language-python">#Start WebApp
app = xpl.run_app(port=8850, title_story='Explanation')
# Kill the wepapp
app.kill()</code></pre>
<h2 id="explainerdashboard">Explainerdashboard<a class="headerlink" href="#explainerdashboard" title="Permanent link"></a></h2>
<pre class="highlight"><code class="language-python">#!pip install explainerdashboard</code></pre>
<pre class="highlight"><code class="language-python">from IPython.core.interactiveshell import InteractiveShell
InteractiveShell.ast_node_interactivity = "all"
from explainerdashboard import ClassifierExplainer, ExplainerDashboard</code></pre>
<pre class="highlight"><code class="language-python">patient_idx=X_test.index
patient_idx</code></pre>
<pre class="highlight"><code class="language-python">explainerdb = ClassifierExplainer(model, X_test, y_test, 
                                    X_background=X_train, 
                                    model_output='y_pred',
                                    idxs=patient_idx,
                                    labels=['WT', 'MUT'])</code></pre>
<pre class="highlight"><code class="language-python">db = ExplainerDashboard(explainerdb)</code></pre>
<pre class="highlight"><code class="language-python">#Run the dashboard webApp
db.run(port=8050, mode='external')</code></pre>
<pre class="highlight"><code class="language-python">db.terminate(8050)</code></pre>
<pre class="highlight"><code class="language-python"></code></pre>
<pre class="highlight"><code class="language-python"></code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../Machine%20learning/tensorflow_API_tutorial/tensorflow_API_tutorial/" class="btn btn-neutral float-left" title="tensorflow API tutorial"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../../about/release-notes/" class="btn btn-neutral float-right" title="Release Notes">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright &copy; 2024 <a href="https://www.linkedin.com/in/lamine-toure">Lamine TOURE</a>, Maintained by <a href="https://github.com/LamineTourelab">Lamine TOURE</a>.</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/LamineTourelab/Tutorial" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../../Machine%20learning/tensorflow_API_tutorial/tensorflow_API_tutorial/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../../about/release-notes/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../js/base.js"></script>
      <script src="../../../js/bootstrap.min.js"></script>
      <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
